openapi: 3.0.0
info:
  title: 訪客註冊系統 API
  version: 1.0.0
  description: 訪客註冊系統 API 文件，包含取得資訊、發送 OTP 及註冊功能。
servers:
  - url: https://vistor.zeroflare.tw/api/
tags:
  - name: checkin
    description: 簽到頁面 API
  - name: register
    description: 註冊頁面 API
  - name: dashboard
    description: 後台登入 API

paths:
  /checkin/info:
    get:
      tags:
        - checkin
      summary: 取得櫃檯資訊
      description: 依櫃檯代號取得櫃檯的名稱與說明。
      parameters:
        - name: counter
          in: query
          required: true
          schema:
            type: string
          description: 櫃檯編號或名稱
          example: "Counter-A"
      responses:
        "200":
          description: 成功取得櫃檯資訊
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                    description: 櫃檯名稱
                    example: "延平一樓櫃檯"
                  description:
                    type: string
                    description: 櫃檯說明
                    example: "提供訪客簽到與證件查驗服務"
        "404":
          description: 找不到櫃檯
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Counter not found"
 
  /checkin/qrcode:
    get:
      tags:
        - checkin
      summary: 取得訪問者簽到 QRCode
      description: 取得用於皮夾登入的 QRCode 及連結。
      parameters:
        - name: transactionId
          in: query
          required: true
          schema:
            type: string
          description: 本次登入流程的 Transaction ID
          example: "f66ea4a9-aaaa-4e9a-a3bc-0a82ca1ea276"
        - name: counter
          in: query
          required: true
          schema:
            type: string
          description: 櫃檯編號或名稱
          example: "Counter-A"
      responses:
        "200":
          description: 成功取得 QRCode
          content:
            application/json:
              schema:
                type: object
                properties:
                  qrcodeImage:
                    type: string
                    description: 皮夾登入Qrcode
                    example: "data:image/png;base64, xxxxx"
                  authUri:
                    type: string
                    description: 皮夾登入網址
                    example: "modadigitalwallet://authorize"
  /checkin/result:
    get:
      tags:
        - checkin
      summary: 檢查簽到狀態
      description: 檢查訪客是否已完成簽到。
      parameters:
        - name: transactionId
          in: query
          required: true
          schema:
            type: string
          description: 本次登入流程的 Transaction ID
          example: "f66ea4a9-aaaa-4e9a-a3bc-0a82ca1ea276"
        - name: counter
          in: query
          required: true
          schema:
            type: string
          description: 櫃檯編號或名稱
          example: "Counter-A"
      responses:
        "200":
          description: 完成登入
          content:
            application/json:
              schema:
                type: object
                properties:
                  inviterEmail:
                    type: string
                    example: "a@moda.gov.tw"
                  inviterName:
                    type: string
                    example: "邀請者姓名"
                  inviterDept:
                    type: string
                    example: "邀請者單位"
                  inviterTitle:
                    type: string
                    example: "邀請者職稱"
                  vistorEmail:
                    type: string
                    example: "hchou@company.com"
                  vistorName:
                    type: string
                    example: "訪問者姓名"
                  vistorDept:
                    type: string
                    example: "訪問者公司"
                  vistorPhone:
                    type: string
                    example: "訪問者電話"
                  meetingTime:
                    type: string
                    example: "會議時間"
                  meetingRoom:
                    type: string
                    example: "會議室"
        "400":
          description: 等待登入
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Waiting for login"
        "401":
          description: 今日沒有會議
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Waiting for login"
  /register/otp:
    post:
      tags:
        - register
      summary: 發送 Email OTP
      description: 發送驗證碼 (OTP) 到該 Email。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  description: 訪客 Email
              required:
                - email
      responses:
        "200":
          description: OTP 發送成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "OTP sent successfully"
  /register/qrcode:
    post:
      tags:
        - register
      summary: 提交訪客註冊資料
      description: 提交訪客的姓名、電話、單位及收到的 OTP 進行註冊。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  description: 訪客 email
                  example: "test@example.com"
                name:
                  type: string
                  description: 姓名
                  example: "王小明"
                phone:
                  type: string
                  description: 電話
                  example: "0912345678"
                company:
                  type: string
                  description: 單位
                  example: "小明有限公司"
                otp:
                  type: string
                  description: Email 驗證碼
                  example: "123456"
              required:
                - token
                - name
                - phone
                - unit
                - otp
      responses:
        "200":
          description: 註冊成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Registration successful"
                  qrcodeImage:
                    type: string
                    description: 皮夾登入Qrcode
                    example: "data:image/png;base64, xxxxx"
                  authUri:
                    type: string
                    description: 皮夾登入網址
                    example: "modadigitalwallet://authorize"
                  transactionId:
                    type: string
                    description: 本次流程的 Transaction ID
                    example: "f66ea4a9-aaaa-4e9a-a3bc-0a82ca1ea276"
  /register/result:
    get:
      tags:
        - register
      summary: 檢查皮夾註冊狀態
      description: 檢查訪客是否已完成皮夾註冊。
      parameters:
        - name: transactionId
          in: query
          required: true
          schema:
            type: string
          description: 本次註冊流程的 Transaction ID
          example: "f66ea4a9-aaaa-4e9a-a3bc-0a82ca1ea276"
      responses:
        "200":
          description: 完成註冊
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Registration completed"
                  credential:
                    type: string
                    example: "JWT"
        "400":
          description: 等待註冊
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Waiting for registration"

  /dashboard/login/otp:
    post:
      tags:
        - dashboard
      summary: 發送 Dashboard 登入 OTP
      description: 透過 Email 發送一次性驗證碼供後台登入使用。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                  description: 使用者 Email
                  example: "admin@example.com"
              required:
                - email
      responses:
        "200":
          description: OTP 發送成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "OTP sent"

  /dashboard/login/result:
    post:
      tags:
        - dashboard
      summary: 驗證 Dashboard 登入 OTP
      description: 驗證使用者輸入的 OTP 並完成登入。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                  description: 使用者 Email
                  example: "admin@example.com"
                otp:
                  type: string
                  description: 一次性驗證碼
                  example: "123456"
              required:
                - email
                - otp
      responses:
        "200":
          description: 登入成功 (Session 已透過 Set-Cookie 設定)
          headers:
            Set-Cookie:
              description: Session cookie 用於後續請求驗證
              schema:
                type: string
                example: "session=abc123; HttpOnly; Secure; SameSite=Lax"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Login successful"
        "400":
          description: OTP 驗證失敗或過期
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Invalid or expired OTP"

  /dashboard/checklogs:
    get:
      tags:
        - dashboard
      summary: 查詢簽到簽到簽退原始資料
      description: 取得歷史簽到記錄，包含產生時間與簽到結果資訊。
      responses:
        "200":
          description: 成功取得簽到紀錄
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    timestamp:
                      type: string
                      format: date-time
                      description: 時間
                      example: "2025-11-27T10:00:00Z"
                    type:
                      type: string
                      example: "簽到/簽退"
                    inviterEmail:
                      type: string
                      example: "a@moda.gov.tw"
                    inviterName:
                      type: string
                      example: "邀請者姓名"
                    inviterDept:
                      type: string
                      example: "邀請者單位"
                    inviterTitle:
                      type: string
                      example: "邀請者職稱"
                    vistorEmail:
                      type: string
                      example: "hchou@company.com"
                    vistorName:
                      type: string
                      example: "訪問者姓名"
                    vistorDept:
                      type: string
                      example: "訪問者公司"
                    vistorPhone:
                      type: string
                      example: "訪問者電話"
                    meetingTime:
                      type: string
                      example: "會議時間"
                    meetingName:
                      type: string
                      example: "會議名稱"
                    meetingRoom:
                      type: string
                      example: "會議室"

  /dashboard/vistorlogs:
    get:
      tags:
        - dashboard
      summary: 依據google日曆的簽到簽退紀錄
      description: 取得歷史簽到記錄，包含產生時間與簽到結果資訊。
      responses:
        "200":
          description: 成功取得簽到紀錄
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    checkinTimestamp:
                      type: string
                      format: date-time
                      description: 簽到時間
                      example: "2025-11-27T10:00:00Z"
                    checkoutTimestamp:
                      type: string
                      format: date-time
                      description: 簽退時間
                      example: "2025-11-27T10:00:00Z"
                    inviterEmail:
                      type: string
                      example: "a@moda.gov.tw"
                    inviterName:
                      type: string
                      example: "邀請者姓名"
                    inviterDept:
                      type: string
                      example: "邀請者單位"
                    inviterTitle:
                      type: string
                      example: "邀請者職稱"
                    vistorEmail:
                      type: string
                      example: "hchou@company.com"
                    vistorName:
                      type: string
                      example: "訪問者姓名"
                    vistorDept:
                      type: string
                      example: "訪問者公司"
                    vistorPhone:
                      type: string
                      example: "訪問者電話"
                    meetingTime:
                      type: string
                      example: "會議時間"
                    meetingName:
                      type: string
                      example: "會議名稱"
                    meetingRoom:
                      type: string
                      example: "會議室"

  /dashboard/users:
    get:
      tags:
        - dashboard
      summary: 取得使用者列表
      description: 取得所有後台使用者。
      responses:
        "200":
          description: 成功取得使用者列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"
    post:
      tags:
        - dashboard
      summary: 新增使用者
      description: 建立一位新的後台使用者。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserInput"
      responses:
        "201":
          description: 建立成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"

  /dashboard/users/{email}:
    parameters:
      - name: email
        in: path
        required: true
        schema:
          type: string
        description: 使用者 Email
        example: "user@example.com"
    get:
      tags:
        - dashboard
      summary: 取得單一使用者
      description: 取得特定使用者的詳細資訊。
      responses:
        "200":
          description: 成功取得使用者
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "404":
          description: 找不到使用者
    put:
      tags:
        - dashboard
      summary: 更新使用者
      description: 更新特定使用者的資訊。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserInput"
      responses:
        "200":
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "404":
          description: 找不到使用者
    delete:
      tags:
        - dashboard
      summary: 刪除使用者
      description: 刪除特定使用者。
      responses:
        "204":
          description: 刪除成功 (無內容)
        "404":
          description: 找不到使用者

  /dashboard/me:
    get:
      tags:
        - dashboard
      summary: 取得目前登入使用者資料
      description: 回傳目前登入中使用者的資訊。
      responses:
        "200":
          description: 成功取得使用者資料
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"

components:
  schemas:
    User:
      type: object
      properties:
        username:
          type: string
          example: "visitor-admin"
        email:
          type: string
          format: email
          example: "admin@example.com"
        role:
          type: string
          enum: ["admin", "staff", "viewer"]
          example: "admin"
    UserInput:
      type: object
      required:
        - username
        - email
        - role
      properties:
        username:
          type: string
          example: "visitor-admin"
        email:
          type: string
          format: email
          example: "admin@example.com"
        role:
          type: string
          enum: ["admin", "staff", "viewer"]
          example: "staff"